<app-sidebar #sidebar></app-sidebar>
<div class="app-bg">
  <section class="home-section">
    <!-- Header Section -->
    <div class="header-section">
      <h1>Sales Analytics</h1>
      <p class="subtitle">Comprehensive sales performance and revenue analysis</p>
    </div>

    <!-- Date Filter Section -->
    <div class="filter-section">
      <div class="filter-card">
        <h3>Date Range Filter</h3>
        <!-- Time selector removed - will be rebuilt from scratch -->
      </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-overlay" *ngIf="loading">
      <div class="loading-spinner">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Loading sales data...</span>
      </div>
    </div>

    <!-- KPI Cards Section -->
    <div class="kpi-section" *ngIf="salesKPI && !loading">
      <div class="kpi-grid">
        <!-- Revenue Card -->
        <div class="kpi-card revenue-card">
          <div class="kpi-icon">
            <i class="pi pi-dollar"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatCurrency(salesKPI.revenue) }}</div>
            <div class="kpi-label">Total Revenue</div>
          </div>
        </div>

        <!-- Orders Card -->
        <div class="kpi-card orders-card">
          <div class="kpi-icon">
            <i class="pi pi-shopping-cart"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatNumber(salesKPI.totalOrders) }}</div>
            <div class="kpi-label">Total Orders</div>
          </div>
        </div>

        <!-- Customers Card -->
        <div class="kpi-card customers-card">
          <div class="kpi-icon">
            <i class="pi pi-users"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatNumber(salesKPI.uniqueCustomers) }}</div>
            <div class="kpi-label">Unique Customers</div>
          </div>
        </div>

        <!-- Average Order Card -->
        <div class="kpi-card avg-order-card">
          <div class="kpi-icon">
            <i class="pi pi-chart-line"></i>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatCurrency(salesKPI.avgOrder) }}</div>
            <div class="kpi-label">Average Order</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section" *ngIf="!loading">
      <div class="charts-grid">
        <!-- Sales Trend Chart -->
        <div class="chart-card" *ngIf="salesTrendChart">
          <h3>Sales Trend Over Time</h3>
          <apx-chart
            [series]="salesTrendChart.series!"
            [chart]="salesTrendChart.chart!"
            [xaxis]="salesTrendChart.xaxis!"
            [yaxis]="salesTrendChart.yaxis!"
            [stroke]="salesTrendChart.stroke!"
            [dataLabels]="salesTrendChart.dataLabels!"
            [tooltip]="salesTrendChart.tooltip!"
            [fill]="salesTrendChart.fill!"
            [colors]="salesTrendChart.colors!">
          </apx-chart>
        </div>

        <!-- Revenue by Category Chart -->
        <div class="chart-card" *ngIf="categoryRevenueChart">
          <h3>Revenue by Product Category</h3>
          <apx-chart
            [series]="categoryRevenueChart.series!"
            [chart]="categoryRevenueChart.chart!"
            [xaxis]="categoryRevenueChart.xaxis!"
            [yaxis]="categoryRevenueChart.yaxis!"
            [stroke]="categoryRevenueChart.stroke!"
            [dataLabels]="categoryRevenueChart.dataLabels!"
            [tooltip]="categoryRevenueChart.tooltip!"
            [plotOptions]="categoryRevenueChart.plotOptions!"
            [colors]="categoryRevenueChart.colors!">
          </apx-chart>
        </div>

        <!-- Revenue by Store Chart -->
        <div class="chart-card" *ngIf="revenueByStoreChart">
          <h3>Top 10 Stores by Revenue</h3>
          <apx-chart
            [series]="revenueByStoreChart.series!"
            [chart]="revenueByStoreChart.chart!"
            [xaxis]="revenueByStoreChart.xaxis!"
            [yaxis]="revenueByStoreChart.yaxis!"
            [stroke]="revenueByStoreChart.stroke!"
            [dataLabels]="revenueByStoreChart.dataLabels!"
            [tooltip]="revenueByStoreChart.tooltip!"
            [plotOptions]="revenueByStoreChart.plotOptions!"
            [colors]="revenueByStoreChart.colors!">
          </apx-chart>
        </div>
      </div>
    </div>

    <!-- Data Tables Section -->
    <div class="tables-section" *ngIf="!loading">
      <div class="tables-grid">
        <!-- Best Selling Products -->
        <div class="table-card">
          <div class="table-header">
            <h3>Best Selling Products</h3>
            <div class="table-controls">
              <button class="sort-btn" (click)="toggleProductsSort()">
                <i class="pi" [class.pi-sort-amount-down]="productsSortOrder === 'desc'" 
                   [class.pi-sort-amount-up]="productsSortOrder === 'asc'"></i>
                {{ productsSortOrder === 'desc' ? 'Top to Bottom' : 'Bottom to Top' }}
              </button>
              <button class="toggle-btn" (click)="showAllProducts = !showAllProducts">
                {{ showAllProducts ? 'Show Top 5' : 'Show All' }}
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Product Name</th>
                  <th>Size</th>
                  <th>Revenue</th>
                  <th>Units Sold</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of getDisplayedProducts(); let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>{{ product.name }}</td>
                  <td>{{ product.size }}</td>
                  <td>{{ formatCurrency(product.revenue) }}</td>
                  <td>{{ formatNumber(product.totalSold) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Store Performance -->
        <div class="table-card">
          <h3>Store Performance</h3>
          <div class="store-performance-grid">
            <!-- Best Store -->
            <div class="store-card best-store" *ngIf="getBestStore()">
              <div class="store-header">
                <i class="pi pi-trophy"></i>
                <h4>Best Performing Store</h4>
              </div>
              <div class="store-content">
                <div class="store-name">{{ getBestStore()?.city }}, {{ getBestStore()?.stateAbbr }}</div>
                <div class="store-revenue">Revenue: {{ formatCurrency(getBestStore()?.revenue || 0) }}</div>
                <div class="store-orders">Orders: {{ formatNumber(getBestStore()?.orders || 0) }}</div>
              </div>
            </div>
            <!-- Worst Store -->
            <div class="store-card worst-store" *ngIf="getWorstStore()">
              <div class="store-header">
                <i class="pi pi-flag"></i>
                <h4>Lowest Performing Store</h4>
              </div>
              <div class="store-content">
                <div class="store-name">{{ getWorstStore()?.city }}, {{ getWorstStore()?.stateAbbr }}</div>
                <div class="store-revenue">Revenue: {{ formatCurrency(getWorstStore()?.revenue || 0) }}</div>
                <div class="store-orders">Orders: {{ formatNumber(getWorstStore()?.orders || 0) }}</div>
              </div>
            </div>
          </div>
          <!-- All Stores Table -->
          <div class="table-container" *ngIf="storesByRevenue.length">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Store</th>
                  <th>Revenue</th>
                  <th>Orders</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let store of storesByRevenue; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>{{ store.city }}, {{ store.stateAbbr }}</td>
                  <td>{{ formatCurrency(store.revenue) }}</td>
                  <td>{{ formatNumber(store.orders) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Analytics Section -->
    <div class="analytics-section" *ngIf="!loading">
      <div class="analytics-grid">
        <!-- Category Performance -->
        <div class="analytics-card" *ngIf="categoryRevenue.length > 0">
          <h3>Category Performance Summary</h3>
          <div class="category-list">
            <div class="category-item" *ngFor="let category of categoryRevenue">
              <div class="category-info">
                <span class="category-name">{{ category.category }}</span>
                <span class="category-orders">{{ formatNumber(category.orders) }} orders</span>
              </div>
              <div class="category-revenue">{{ formatCurrency(category.revenue) }}</div>
            </div>
          </div>
        </div>

        <!-- Sales Insights -->
        <div class="analytics-card">
          <h3>Sales Insights</h3>
          <div class="insights-list">
            <div class="insight-item" *ngIf="salesKPI">
              <i class="pi pi-chart-pie"></i>
              <span>Average order value is {{ formatCurrency(salesKPI.avgOrder) }}</span>
            </div>
            <div class="insight-item" *ngIf="salesKPI && salesKPI.totalOrders > 0">
              <i class="pi pi-percentage"></i>
              <span>Customer retention rate: {{ ((salesKPI.uniqueCustomers / salesKPI.totalOrders) * 100).toFixed(1) }}%</span>
            </div>
            <div class="insight-item" *ngIf="bestSellingProducts.length > 0">
              <i class="pi pi-star"></i>
              <span>Top product: {{ bestSellingProducts[0]?.name }} ({{ formatCurrency(bestSellingProducts[0]?.revenue || 0) }})</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<app-loading-popup
  [isVisible]="loading"
  [title]="'Loading Sales Data'"
  [message]="loadingMessage"
  [progress]="loading ? 50 : 100"
  [showDetails]="false">
</app-loading-popup>