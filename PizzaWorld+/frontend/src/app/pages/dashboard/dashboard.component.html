<app-sidebar></app-sidebar>

<!-- Loading Popup for Refresh -->
<app-loading-popup
  [isVisible]="showLoadingPopup"
  title="Refreshing Dashboard Data"
  [message]="loadingMessage"
  [progress]="loadingProgress"
  [showDetails]="false">
</app-loading-popup>

<div class="home-section">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>Dashboard</h1>
      <div class="header-actions">
        <div class="last-updated" *ngIf="dataLastUpdated">
          <i class="pi pi-clock"></i>
          <span>Last updated: {{ dataLastUpdated | date:'short' }}</span>
        </div>
        <button pButton type="button"
                icon="pi pi-refresh"
                label="Refresh Data"
                class="p-button-outlined"
                (click)="refreshData()"
                [disabled]="loading || showLoadingPopup">
        </button>
      </div>
    </div>
  </div>

  <!-- Time Selector -->
  <app-time-selector
    [selectedPeriod]="selectedPeriod"
    (periodChange)="onTimePeriodChange($event)">
  </app-time-selector>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <i class="pi pi-spin pi-spinner" style="font-size: 2rem; margin-bottom: 1rem;"></i>
    <div>Loading dashboard data...</div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <i class="pi pi-exclamation-triangle" style="font-size: 2rem; color: #f44336; margin-bottom: 1rem;"></i>
    <div>Failed to load dashboard data</div>
    <button pButton type="button" label="Retry" class="p-button-outlined" (click)="loadDashboardData()" style="margin-top: 1rem;"></button>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading && !error && performanceData" class="dashboard-content">
    <!-- Global KPIs -->
    <div class="kpi-grid">
      <p-card class="kpi-card">
        <ng-template pTemplate="header">
          <div class="kpi-header">
            <i class="pi pi-dollar"></i>
            <span>Total Revenue</span>
          </div>
        </ng-template>
        <ng-template pTemplate="content">
          <div class="kpi-value">{{ formatCurrency(performanceData.globalKPIs.totalRevenue) }}</div>
        </ng-template>
      </p-card>

      <p-card class="kpi-card">
        <ng-template pTemplate="header">
          <div class="kpi-header">
            <i class="pi pi-shopping-cart"></i>
            <span>Total Orders</span>
          </div>
        </ng-template>
        <ng-template pTemplate="content">
          <div class="kpi-value">{{ formatNumber(performanceData.globalKPIs.totalOrders) }}</div>
        </ng-template>
      </p-card>

      <p-card class="kpi-card">
        <ng-template pTemplate="header">
          <div class="kpi-header">
            <i class="pi pi-chart-line"></i>
            <span>Avg Order Value</span>
          </div>
        </ng-template>
        <ng-template pTemplate="content">
          <div class="kpi-value">{{ formatCurrency(performanceData.globalKPIs.avgOrderValue) }}</div>
        </ng-template>
      </p-card>

      <p-card class="kpi-card">
        <ng-template pTemplate="header">
          <div class="kpi-header">
            <i class="pi pi-users"></i>
            <span>Unique Customers</span>
          </div>
        </ng-template>
        <ng-template pTemplate="content">
          <div class="kpi-value">{{ formatNumber(performanceData.globalKPIs.totalCustomers) }}</div>
        </ng-template>
      </p-card>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <p-card>
        <ng-template pTemplate="header">
          <h3>Revenue by Store</h3>
        </ng-template>
        <ng-template pTemplate="content">
          <apx-chart
            *ngIf="revenueChartOpts"
            [series]="revenueChartOpts.series"
            [chart]="revenueChartOpts.chart"
            [xaxis]="revenueChartOpts.xaxis"
            [yaxis]="revenueChartOpts.yaxis"
            [dataLabels]="revenueChartOpts.dataLabels"
            [stroke]="revenueChartOpts.stroke"
            [tooltip]="revenueChartOpts.tooltip">
          </apx-chart>
        </ng-template>
      </p-card>

      <p-card>
        <ng-template pTemplate="header">
          <h3>Orders by Store</h3>
        </ng-template>
        <ng-template pTemplate="content">
          <apx-chart
            *ngIf="ordersChartOpts"
            [series]="ordersChartOpts.series"
            [chart]="ordersChartOpts.chart"
            [xaxis]="ordersChartOpts.xaxis"
            [yaxis]="ordersChartOpts.yaxis"
            [dataLabels]="ordersChartOpts.dataLabels"
            [stroke]="ordersChartOpts.stroke"
            [tooltip]="ordersChartOpts.tooltip">
          </apx-chart>
        </ng-template>
      </p-card>
    </div>
  </div>
</div>
