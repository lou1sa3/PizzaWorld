<app-sidebar></app-sidebar>
<div class="home-section">
  <!-- Modern Upper Section -->
  <div class="stores-upper-section">
    <div class="stores-stats-row">
      <div class="fancy-total-stores-box">
        <span class="fancy-total-stores-icon"><i class="pi pi-building"></i></span>
        <span class="fancy-total-stores-info">
          <span class="fancy-total-stores-number">{{ getTotalStores() }}</span>
          <span class="fancy-total-stores-label">Total Stores</span>
        </span>
      </div>
      <div class="filtered-results-box">
        <span class="filtered-results-number">{{ getStoreCount() }}</span>
        <span class="filtered-results-label">Filtered Results</span>
      </div>
    </div>
    <div class="stores-filter-card">
      <div class="stores-filter-header">
        <span class="filter-title">Search & Filter Stores</span>
        <div class="filter-actions">
          <button pButton type="button"
                  label="Export All"
                  icon="pi pi-download"
                  class="p-button-outlined p-button-sm"
                  (click)="exportStores()"
                  [loading]="exportLoading"
                  [disabled]="allStores.length === 0">
          </button>
          <button pButton type="button"
                  label="Export Filtered"
                  icon="pi pi-filter"
                  class="p-button-outlined p-button-sm"
                  (click)="exportFilteredStores()"
                  [disabled]="filteredStores.length === 0">
          </button>
          <button pButton type="button"
                  label="Clear Filters"
                  class="p-button-outlined p-button-sm"
                  (click)="clearFilters()"
                  [disabled]="!searchTerm && selectedStates.length === 0">
          </button>
        </div>
      </div>
      <div class="stores-filter-fields">
        <div class="filter-field">
          <label for="search" class="filter-label">Search Stores</label>
          <span class="p-input-icon-left p-w-full">
            <i class="pi pi-search"></i>
            <input pInputText id="search"
                   [(ngModel)]="searchTerm"
                   (input)="onSearchChange()"
                   placeholder="Search by store ID, city, zip code, or state..."
                   class="p-w-full" />
          </span>
        </div>
        <div class="filter-field">
          <label for="state" class="filter-label">Filter by State</label>
          <p-multiselect id="state"
                        [(ngModel)]="selectedStates"
                        [options]="states"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Select states..."
                        (onChange)="onStateChange()"
                        [filter]="false"
                        class="p-w-full">
            <ng-template let-state pTemplate="item">
              <div class="state-dropdown-item">
                <span class="state-badge-dropdown">[{{ state.label }}]</span>
              </div>
            </ng-template>
          </p-multiselect>
        </div>
      </div>
    </div>
  </div>

  <!-- Stores Table -->
  <p-card>
    <ng-template pTemplate="header">
      <div class="table-header">
        <h3>Store Locations ({{ getStoreCount() }} stores)</h3>
        <div class="table-actions" *ngIf="getSelectedCount() > 0">
          <span class="selected-count">{{ getSelectedCount() }} selected</span>
          <button pButton type="button"
                  label="Clear Selection"
                  icon="pi pi-times"
                  class="p-button-text p-button-sm"
                  (click)="clearSelection()">
          </button>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="content">
      <ng-container *ngIf="!loading && !error; else loadingOrError">
        <div class="modern-table-container">
          <p-table
            [value]="filteredStores"
            [selectionMode]="'multiple'"
            [(selection)]="selectedStores"
            (onRowSelect)="onRowSelect($event)"
            (onRowUnselect)="onRowUnselect($event)"
            (onSort)="onSort($event)"
            [sortMode]="'single'"
            [sortField]="sortField"
            [sortOrder]="sortOrder"
            [scrollable]="true"
            scrollHeight="600px"
            [lazy]="false"
            [virtualScroll]="false"
            styleClass="modern-table">

            <ng-template pTemplate="header">
              <tr>
                <th style="width: 4rem">
                  <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th>
                <th pSortableColumn="storeid" style="width: 120px">
                  Store ID
                  <p-sortIcon field="storeid"></p-sortIcon>
                </th>
                <th pSortableColumn="city" style="width: 200px">
                  City
                  <p-sortIcon field="city"></p-sortIcon>
                </th>
                <th pSortableColumn="state" style="width: 150px">
                  State
                  <p-sortIcon field="state"></p-sortIcon>
                </th>
                <th pSortableColumn="zipcode" style="width: 120px">
                  Zip Code
                  <p-sortIcon field="zipcode"></p-sortIcon>
                </th>
                <th style="width: 150px">
                  Coordinates
                </th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-store>
              <tr class="store-row">
                <td>
                  <p-tableCheckbox [value]="store"></p-tableCheckbox>
                </td>
                <td class="store-id">
                  <span class="store-id-text clickable"
                        (click)="navigateToStoreDetails(store)"
                        pTooltip="Click to view store details"
                        tooltipPosition="top">
                    {{ store.storeid }}
                  </span>
                </td>
                <td class="store-city">{{ store.city }}</td>
                <td class="store-state">
                  <span class="state-badge">[{{ store.state_abbr }}]</span>
                  <span class="state-name">{{ store.state }}</span>
                </td>
                <td class="store-zip">{{ store.zipcode }}</td>
                <td class="store-coordinates">
                  <span class="coordinates-link"
                        pTooltip="Click to open in Google Maps"
                        tooltipPosition="top"
                        (click)="openInMaps(store.latitude, store.longitude)">
                    {{ formatCoordinates(store.latitude, store.longitude) }}
                  </span>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="6" class="no-results">
                  <i class="pi pi-search"></i>
                  <p>No stores found matching your criteria</p>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </ng-container>

      <ng-template #loadingOrError>
        <div class="p-d-flex p-flex-column p-ai-center p-jc-center" style="min-height:200px;">
          <ng-container *ngIf="loading; else errorState">
            <i class="pi pi-spin pi-spinner" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <div>Loading stores data...</div>
          </ng-container>
          <ng-template #errorState>
            <i class="pi pi-exclamation-triangle" style="font-size: 2rem; color: #f44336; margin-bottom: 1rem;"></i>
            <div>Failed to load stores data</div>
            <button pButton type="button" label="Retry" class="p-button-outlined" (click)="loadStoresData()" style="margin-top: 1rem;"></button>
          </ng-template>
        </div>
      </ng-template>
    </ng-template>
  </p-card>

  <!-- Stores Growth Chart -->
  <p-card class="p-mt-4" *ngIf="storesOpts">
    <ng-template pTemplate="header">
      <h3>Store Growth Over Time</h3>
    </ng-template>
    <ng-template pTemplate="content">
      <apx-chart
        [series]="storesOpts.series"
        [chart]="storesOpts.chart"
        [xaxis]="storesOpts.xaxis"
        [yaxis]="storesOpts.yaxis"
        [stroke]="storesOpts.stroke"
        [dataLabels]="storesOpts.dataLabels"
        [tooltip]="storesOpts.tooltip">
      </apx-chart>
    </ng-template>
  </p-card>
</div>
